
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sirasa TV | Zerocast</title>
    <link rel="icon" type="image/png" href="https://zerocastor.com/assets/fav.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.1/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root { --accent: #007AFF; --accent-glow: rgba(0, 122, 255, 0.4); --bg: #000; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; }

        .ambient-bg { position: fixed; inset: 0; background: url('https://api3.viu.lk/api/client/v1/global/images/25667?accessKey=WkVjNWNscFhORDBLCg==') center/cover; filter: blur(80px) brightness(0.2); z-index: 1; transform: scale(1.2); }

        #video-container { position: fixed; inset: 0; width: 100%; height: 100%; background: #000; z-index: 10; display: none; }
        #video-container.active { display: block; }
        #video { width: 100%; height: 100%; }

        .shaka-controls-container { display: none !important; }

        #loader-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .app-loader { width: 50px; height: 50px; border: 4px solid rgba(0, 122, 255, 0.1); border-left-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        .loader-text { margin-top: 20px; font-size: 11px; letter-spacing: 5px; font-weight: 800; color: var(--accent); animation: pulse 1.5s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 0.3; filter: blur(1px); } 50% { opacity: 1; filter: blur(0px); } }

        #app-gate { position: fixed; inset: 0; z-index: 9999; display: flex; align-items: center; justify-content: center; background: #000; }
        .app-card { width: 90%; max-width: 400px; padding: 40px 30px; background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(40px); border-radius: 40px; border: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .progress-line { width: 100%; height: 5px; background: rgba(255,255,255,0.1); border-radius: 10px; margin: 20px 0; overflow: hidden; }
        #progress-fill { width: 0%; height: 100%; background: var(--accent); transition: 1s linear; }
        .ad-box { width: 300px; height: 250px; background: #111; margin: 15px auto; border-radius: 20px; overflow: hidden; border: 1px solid #333; }
        #action-btn { width: 100%; height: 60px; border-radius: 18px; background: #222; color: #555; font-size: 15px; font-weight: 800; border: none; cursor: pointer; transition: 0.3s; }
        #action-btn.ready { background: var(--accent); color: #fff; box-shadow: 0 10px 20px rgba(0,122,255,0.3); }

        .top-ui { position: absolute; top: 0; left: 0; right: 0; padding: 25px; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .control-btn { width: 45px; height: 45px; border-radius: 50%; background: rgba(255,255,255,0.1); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; transition: 0.3s; }
        .control-btn:hover { background: var(--accent); }

        .fs-btn { position: fixed; bottom: 30px; right: 30px; z-index: 100; width: 55px; height: 55px; background: rgba(0,0,0,0.6); border-radius: 50%; display: none; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.1); color: #fff; cursor: pointer; font-size: 20px; transition: 0.3s; }
        .fs-btn:hover { background: var(--accent); }

        .player-brand { position: absolute; bottom: 30px; left: 30px; z-index: 20; opacity: 0.6; pointer-events: none; }
        .player-brand img { height: 35px; filter: drop-shadow(0 0 10px var(--accent-glow)); }

        #rewind-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1999; display: none; }
        #rewind-overlay.active { display: block; }
        .sheet-rewind { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15,15,15,0.98); padding: 30px 25px 40px; border-radius: 35px 35px 0 0; z-index: 2000; transform: translateY(100%); transition: 0.4s cubic-bezier(0.1, 0.9, 0.2, 1); visibility: hidden; }
        .sheet-rewind.active { transform: translateY(0); visibility: visible; }
        .date-scroller { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 20px; scrollbar-width: none; }
        .date-box { min-width: 75px; background: #222; padding: 12px; border-radius: 15px; text-align: center; cursor: pointer; }
        .date-box.selected { background: var(--accent); box-shadow: 0 5px 15px var(--accent-glow); }
        .btn-action { width: 100%; background: var(--accent); color: #fff; border: none; padding: 18px; border-radius: 15px; font-weight: 800; margin-top: 15px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="ambient-bg"></div>

    <div id="app-gate">
        <div class="app-card">
            <img src="https://api3.viu.lk/api/client/v1/global/images/25667?accessKey=WkVjNWNscFhORDBLCg==" style="height: 60px; margin-bottom: 15px; border-radius: 15px;">
            <h2 style="font-size: 20px;">Sirasa TV</h2>
            <p id="gate-status" style="font-size: 12px; opacity: 0.5;">Sponsored Ads (6s)...</p>
            <div class="progress-line"><div id="progress-fill"></div></div>
            <div class="ad-box">
                <script type="text/javascript">
                    atOptions = { 'key' : '046a7758b079d39541c728f55813298f', 'format' : 'iframe', 'height' : 250, 'width' : 300, 'params' : {} };
                </script>
                <script type="text/javascript" src="https://www.highperformanceformat.com/046a7758b079d39541c728f55813298f/invoke.js"></script>
            </div>
            <button id="action-btn" onclick="handleAuthorize()">AUTHORIZE STREAM</button>
        </div>
    </div>

    <div id="loader-screen">
        <div class="app-loader"></div>
        <div class="loader-text">ZEROCAST</div>
    </div>

    <div id="video-container">
        <div class="player-brand"><img src="https://zerocastor.com/assets/logo.png" alt="Logo"></div>
        <video id="video" autoplay playsinline></video>
    </div>

    <div class="top-ui" id="ui-top" style="display:none;">
        <div class="control-btn" onclick="location.href='index.php'"><i class="bi bi-chevron-left"></i></div>
        <div style="text-align:center;">
            <div style="font-weight:700; font-size:16px;">Sirasa TV</div>
            <div id="playback-status" style="font-size:10px; color:var(--accent); font-weight:800; letter-spacing:1px;">LIVE SECURE</div>
        </div>
        <div class="control-btn" onclick="toggleRewind()"><i class="bi bi-clock-history"></i></div>
    </div>

    <div class="fs-btn" id="fs-btn" onclick="toggleFullscreen()">
        <i class="bi bi-arrows-fullscreen"></i>
    </div>

    <div id="rewind-overlay" onclick="closeRewind()"></div>
    <div class="sheet-rewind" id="rewindSheet">
        <h3 style="margin-bottom:20px; font-weight:800;">Time Travel (LK)</h3>
        <div class="date-scroller" id="dateGrid"></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="background:#222; padding:12px; border-radius:15px;">
                <label style="font-size:10px; opacity:0.5; display:block; margin-bottom:5px;">START TIME</label>
                <input type="time" id="startTime" style="background:none; border:none; color:#fff; width:100%; font-size:18px;" value="20:00">
            </div>
            <div style="background:#222; padding:12px; border-radius:15px;">
                <label style="font-size:10px; opacity:0.5; display:block; margin-bottom:5px;">END TIME</label>
                <input type="time" id="endTime" style="background:none; border:none; color:#fff; width:100%; font-size:18px;" value="21:00">
            </div>
        </div>
        <button class="btn-action" onclick="startRewind()">WATCH RECORDING</button>
        <button onclick="location.reload()" style="width:100%; background:none; color:#666; border:none; margin-top:15px; font-weight:600;">BACK TO LIVE</button>
    </div>

    <script>
        let player, selectedDate, isReady = false, w = 6;

        // NEW FEATURE flags from PHP
        const STREAM_URL = "https:\/\/viu.cyberyakku.com\/viu.mpd\/?id=8";
        const IS_HLS = 0 === 1;
        const HAS_DRM = 1 === 1;

        const gateTimer = setInterval(() => {
            w--;
            document.getElementById('progress-fill').style.width = ((6-w)/6*100) + "%";
            if(w <= 0) {
                clearInterval(gateTimer);
                isReady = true;
                document.getElementById('action-btn').classList.add('ready');
                document.getElementById('action-btn').innerHTML = 'START STREAMING';
            }
        }, 1000);

        function handleAuthorize() {
            if(!isReady) return;
            window.open('https://www.effectivegatecpm.com/r01ji1qs?key=230df895c8660a3526b18caa5a051add', '_blank');
            document.getElementById('app-gate').style.display = 'none';
            document.getElementById('loader-screen').style.display = 'flex';
            setTimeout(initPlayer, 1500);
        }

        async function initPlayer() {
            shaka.polyfill.installAll();
            const video = document.getElementById('video');
            player = new shaka.Player(video);

            // ONLY configure DRM for DRM channels (MPD/Widevine)
            if (HAS_DRM) {
                player.configure({ drm: { servers: { 'com.widevine.alpha': 'proxy.php?type=license&id=8' } } });
            } else {
                player.configure({ drm: { servers: {} } });
            }

            video.addEventListener('playing', () => {
                document.getElementById('loader-screen').style.display = 'none';
                document.getElementById('video-container').classList.add('active');
                document.getElementById('ui-top').style.display = 'flex';
                document.getElementById('fs-btn').style.display = 'flex';
            });

            try {
                if (IS_HLS) {
                    // HLS direct via proxy (no DRM)
                    document.getElementById('playback-status').textContent = "LIVE";
                    document.getElementById('playback-status').style.color = "var(--accent)";
                    await player.load(`proxy.php?type=direct&url=${encodeURIComponent(http://72.76.0.150/channel/1edf0476/index.m3u8?q=1765986513467)}`);
                } else {
                    // Existing DASH/MPD flow via proxy manifest (DRM or non-DRM)
                    await player.load(`proxy.php?type=manifest&id=8`);
                }
            } catch (e) {
                location.reload();
            }
        }

        // Rewind Logic from your old code
        function toAPITime(dateStr, timeStr) {
            const [year, month, day] = dateStr.split('-');
            const [hour, min] = timeStr.split(':');
            const slDate = new Date(year, month - 1, day, hour, min, 0);
            const utcDate = new Date(slDate.getTime() - (5.5 * 3600000));
            const y = utcDate.getFullYear();
            const m = String(utcDate.getMonth() + 1).padStart(2, '0');
            const d = String(utcDate.getDate()).padStart(2, '0');
            const h = String(utcDate.getHours()).padStart(2, '0');
            const mn = String(utcDate.getMinutes()).padStart(2, '0');
            return `${y}${m}${d}T${h}${mn}00`;
        }

        function startRewind() {
            // Rewind is only for your DASH proxy stream (keep old behavior)
            if (IS_HLS) return;

            const beginTime = toAPITime(selectedDate, document.getElementById('startTime').value);
            const endTimeAPI = toAPITime(selectedDate, document.getElementById('endTime').value);
            closeRewind();
            document.getElementById('loader-screen').style.display = 'flex';
            document.getElementById('playback-status').textContent = "CATCH-UP MODE";
            document.getElementById('playback-status').style.color = "#FF9500";
            player.load(`proxy.php?type=manifest&id=8&rewind=1&begin=${beginTime}&end=${endTimeAPI}`).catch(() => location.reload());
        }

        function toggleFullscreen() {
            const el = document.getElementById('video-container');
            if(!document.fullscreenElement) {
                el.requestFullscreen().then(() => {
                    if (screen.orientation && screen.orientation.lock) {
                        screen.orientation.lock('landscape').catch(() => {});
                    }
                });
            } else { document.exitFullscreen(); }
        }

        function toggleRewind() {
            const sheet = document.getElementById('rewindSheet');
            if(sheet.classList.contains('active')) closeRewind();
            else { sheet.classList.add('active'); document.getElementById('rewind-overlay').classList.add('active'); }
        }
        function closeRewind() {
            document.getElementById('rewindSheet').classList.remove('active');
            document.getElementById('rewind-overlay').classList.remove('active');
        }

        function generateDates() {
            const grid = document.getElementById('dateGrid');
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Colombo"}));
            for(let i=0; i<4; i++){
                const d = new Date(now); d.setDate(now.getDate() - i);
                const iso = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                const div = document.createElement('div');
                div.className = `date-box ${i===0?'selected':''}`;
                if(i===0) selectedDate = iso;
                div.innerHTML = `<div style="font-size:10px; opacity:0.6;">${i===0?'TODAY':d.toLocaleDateString('en-US',{weekday:'short'}).toUpperCase()}</div><div style="font-weight:800; font-size:18px;">${d.getDate()}</div>`;
                div.onclick = () => {
                    document.querySelectorAll('.date-box').forEach(x=>x.classList.remove('selected'));
                    div.classList.add('selected'); selectedDate = iso;
                };
                grid.appendChild(div);
            }
        }
        generateDates();
    </script>
</body>
</html>
